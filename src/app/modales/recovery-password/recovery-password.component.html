<!-- recovery-password -->
<div class="modal-overlay" (click)="closeModal()">
  <div class="modal-container" (click)="$event.stopPropagation()">

    <!-- Header del Modal -->
    <div class="modal-header">
      <h2 class="modal-title">
        <span class="icon-key">ğŸ”</span>
        Cambiar ContraseÃ±a
      </h2>
      <button class="close-btn" (click)="closeModal()" type="button">
        <span class="icon-close">âœ•</span>
      </button>
    </div>

    <!-- Contenido del Modal -->
    <div class="modal-content">

      <!-- Loading State -->
      <div *ngIf="isLoading" class="success-message">
        <div class="success-icon">
          <div class="spinner"></div>
        </div>
        <h3>Validando cÃ³digo...</h3>
        <p>Validando cÃ³digo de recuperaciÃ³n...</p>
      </div>

      <!-- Error State -->
      <div *ngIf="errorMessage && !isLoading" class="success-message">
        <div class="success-icon" style="background: linear-gradient(135deg, #ff4500, #ff1493);">âš ï¸</div>
        <h3>Error de ValidaciÃ³n</h3>
        <p>{{ errorMessage }}</p>
        <button type="button" class="btn-primary" (click)="closeModalToAuth()">
          Volver al Login
        </button>
      </div>

      <!-- Success State -->
      <div *ngIf="isSuccess" class="success-message">
        <div class="success-icon">âœ“</div>
        <h3>Â¡ContraseÃ±a Cambiada!</h3>
        <p>{{ successMessage }}</p>
        <p>SerÃ¡s redirigido al login en unos segundos...</p>
      </div>

      <!-- Main Form -->
      <div *ngIf="isValidSlug && username && !isLoading && !isSuccess">

        <div class="form-description">
          <h5>Cambia tu contraseÃ±a por una nueva. AsegÃºrate de que sea segura y fÃ¡cil de recordar.</h5>
        </div>

        <form (ngSubmit)="onSubmit()" #recoveryForm="ngForm">

          <!-- Username Verification -->
          <div class="form-group">
            <label class="form-label">
              <span class="icon-email">ğŸ‘¤</span>
              Confirma tu nombre de usuario
            </label>
            <input
              type="text"
              class="form-input"
              [class.error]="usernameError"
              [(ngModel)]="usernameInput"
              (input)="onUsernameChange()"
              name="username"
              placeholder="Ingresa tu nombre de usuario"
              required>
            <div *ngIf="usernameError" class="error-message">
              <span class="icon-warning">âš ï¸</span>
              {{ usernameError }}
            </div>
            <div *ngIf="isUsernameValid" class="valid-feedback">
              <span style="color: var(--color-blue);">âœ“</span> Usuario verificado
            </div>
          </div>

          <!-- New Password -->
          <div class="form-group">
            <label class="form-label">
              <span class="icon-email">ğŸ”’</span>
              Nueva ContraseÃ±a
            </label>
            <div class="input-group">
              <input
                [type]="showPassword ? 'text' : 'password'"
                class="form-input"
                [class.error]="passwordError"
                [(ngModel)]="newPassword"
                (input)="onPasswordChange()"
                name="newPassword"
                placeholder="Ingresa tu nueva contraseÃ±a"
                [disabled]="!canEditPasswords"
                required>
              <button
                type="button"
                class="toggle-password-btn"
                (click)="togglePasswordVisibility()"
                [disabled]="!canEditPasswords">
                <span [innerHTML]="showPassword ? 'ğŸ‘ï¸â€ğŸ—¨ï¸' : 'ğŸ‘ï¸'"></span>
              </button>
            </div>
            <div *ngIf="passwordError" class="error-message">
              <span class="icon-warning">âš ï¸</span>
              {{ passwordError }}
            </div>
            <small class="form-text" *ngIf="canEditPasswords">
              Debe contener al menos 8 caracteres, mayÃºsculas, minÃºsculas, nÃºmeros y caracteres especiales.
            </small>
          </div>

          <!-- Confirm Password -->
          <div class="form-group">
            <label class="form-label">
              <span class="icon-email">ğŸ”</span>
              Confirmar Nueva ContraseÃ±a
            </label>
            <div class="input-group">
              <input
                [type]="showConfirmPassword ? 'text' : 'password'"
                class="form-input"
                [class.error]="confirmPasswordError"
                [(ngModel)]="confirmPassword"
                (input)="onConfirmPasswordChange()"
                name="confirmPassword"
                placeholder="Confirma tu nueva contraseÃ±a"
                [disabled]="!canEditPasswords"
                required>
              <button
                type="button"
                class="toggle-password-btn"
                (click)="toggleConfirmPasswordVisibility()"
                [disabled]="!canEditPasswords">
                <span [innerHTML]="showConfirmPassword ? 'ğŸ‘ï¸â€ğŸ—¨ï¸' : 'ğŸ‘ï¸'"></span>
              </button>
            </div>
            <div *ngIf="confirmPasswordError" class="error-message">
              <span class="icon-warning">âš ï¸</span>
              {{ confirmPasswordError }}
            </div>
          </div>

          <!-- Mensaje de Error General -->
          <div *ngIf="errorMessage" class="error-alert">
            <span class="icon-warning">âš ï¸</span>
            {{ errorMessage }}
          </div>

          <!-- Submit Button -->
          <div class="form-actions">
            <button
              type="button"
              class="btn-secondary"
              (click)="closeModalToAuth(); $event.preventDefault()"
              [disabled]="isProcessing">
              Volver al Login
            </button>
            <button
              type="submit"
              class="btn-primary"
              [disabled]="!isFormValid() || isProcessing">
              <span *ngIf="isProcessing" class="spinner"></span>
              <span *ngIf="!isProcessing" class="icon-send">ğŸ”„</span>
              {{ isProcessing ? 'Procesando...' : 'Cambiar ContraseÃ±a' }}
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>
